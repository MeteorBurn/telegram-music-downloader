# Формат ID в Telegram API

## Типы ID в Telegram

В Telegram API используются разные форматы идентификаторов для различения типов чатов:

### 1. Положительные ID (без минуса)

**Формат:** `123456789`  
**Тип:** Обычные пользователи (User)  
**Пример:** `user_id = 987654321`

Используются для идентификации личных аккаунтов пользователей.

---

### 2. Отрицательные ID с одним минусом

**Формат:** `-123456789`  
**Тип:** Обычные группы (Basic Groups)  
**Описание:** Старый формат групп, ограничены до ~200 участников  
**Пример:** `group_id = -123456789`

Это устаревший формат групп с ограниченным функционалом.

---

### 3. Отрицательные ID с префиксом `-100`

**Формат:** `-1001234567890`  
**Тип:** Супергруппы и Каналы (Supergroups & Channels)

**Включает:**
- **Супергруппы**: большие группы с более чем 200 участников
- **Каналы**: для широковещательных сообщений (broadcast channels)

**Структура:**
```
-1001234567890
 ^^^^ ^^^^^^^^^^
 |    |
 |    └─ Внутренний ID: 1234567890
 └────── Префикс для супергрупп/каналов
```

**Пример:** `channel_id = -1001234567890`

---

## Почему это важно?

### 1. Различение типов чатов
По знаку `-` и префиксу Telegram API автоматически определяет тип чата и применяет соответствующие правила обработки.

### 2. Совместимость с разными версиями API
- Старые группы: используют простой минус (`-123`)
- Новые группы/каналы: используют префикс `-100` (`-100123`)

### 3. Внутренняя маршрутизация
Разные типы чатов обрабатываются разными серверами в инфраструктуре Telegram.

---

## Использование в проекте

### Преобразование ID для папок

В нашем проекте мы **убираем** знак `-` (и `@`) из ID при использовании в названиях папок:

**Причины:**
- ✓ Минус в названии папки может вызывать проблемы в некоторых ОС
- ✓ Делает названия более читаемыми
- ✓ Избегаем путаницы с командами в терминале (где `-` = флаг команды)
- ✓ Единообразие для числовых ID и username'ов

### Примеры преобразования

| Значение в config.yaml | Отформатированный ID | Название папки |
|------------------------|----------------------|----------------|
| `-1001234567890` | `1001234567890` | `ChannelName_1001234567890/` |
| `@musicchannel` | `musicchannel` | `ChannelName_musicchannel/` |
| `-123456789` | `123456789` | `GroupName_123456789/` |

### Где применяется отформатированный ID

1. **Названия папок**: `data/downloads/{ChannelTitle}_{formatted_id}/`
2. **Файлы трекеров**: 
   - `message_tracker.json` → `"channel_id": "1001234567890"`
   - `file_tracker.json` → `"channel_id": "1001234567890"`
3. **Метаданные файлов**: В записях о скачанных файлах

### Функция форматирования

```python
# src/channel_utils.py
def format_channel_id(channel_id):
    """Format channel ID for use in folder name"""
    channel_id_str = str(channel_id)
    
    # Remove minus sign
    if channel_id_str.startswith('-'):
        channel_id_str = channel_id_str[1:]
    
    # Remove @ symbol
    if channel_id_str.startswith('@'):
        channel_id_str = channel_id_str[1:]
    
    return channel_id_str
```

---

## Как получить ID канала/группы

### Способ 1: Через ShowJsonBot

1. Перешлите любое сообщение из целевого канала/группы боту [@ShowJsonBot](https://t.me/ShowJsonBot)
2. Бот ответит JSON с информацией о сообщении
3. Найдите в ответе: `"chat": {"id": -1001234567890}`
4. Используйте значение после `"id":` (включая знак минуса)

### Способ 2: Для публичных каналов

Для публичных каналов можно использовать username:
- URL: `https://t.me/musicchannel`
- В config.yaml: `@musicchannel`

---

## Примеры конфигурации

### config.yaml

```yaml
channels:
  # Приватный канал (числовой ID)
  - -1001234567890
  
  # Публичный канал (username)
  - "@musicchannel"
  
  # Приватная группа (старый формат)
  - -123456789
  
  # Супергруппа
  - -1009876543210
```

### Результирующая структура папок

```
data/downloads/
├── MusicRock_1001234567890/
│   ├── message_tracker.json
│   ├── file_tracker.json
│   └── track1.mp3
├── MyMusicChannel_musicchannel/
│   ├── message_tracker.json
│   ├── file_tracker.json
│   └── track2.flac
└── PrivateGroup_123456789/
    ├── message_tracker.json
    ├── file_tracker.json
    └── track3.wav
```

---

## Дополнительная информация

- **Telegram Bot API документация**: https://core.telegram.org/bots/api#chat
- **Telethon документация**: https://docs.telethon.dev/en/stable/
